---
title: "2. Time Series Graphics.RMD"
author: "Russ Conte"
date: "10/2/2021"
output: html_document
---

# 2. Time Series Graphics

## 2.1 `tsibble` objects

How to create a `tsibble`:

```{r 2.1 Creating a tsibble}
library(fpp3)
y <- tsibble(
  Year = 2015:2019,
  Observation  = c(123, 39, 78, 52, 110),
  index = Year
)

y
```

For observations that are more frequent than once per year, we need to use a time class function on the index. For example:

```{r Key bariables}
olympic_running

```

The 14 time series in this object are uniquely identified by the keys: the `Length` and `Sex` variables. The `distinct()` function can be used to show the categories of each variable or even combinations of variables:

```{r Using the distinct function to show categories of each variable}
olympic_running %>% distinct(Sex)
```

## Working with tsibble objects

We can use dplyr functions such as `mutate()`, `filter()`, `select()` and `summarise()` to work with `tsibble` objects.

```{r Look at the PBS data set}
PBS
```

Filter the dataset to extract the A10 scripts:

```{r Filter the dataset to extract the A10 scripts}
a10 <- PBS %>% filter(ATC2 == "A10")
a10
```

Select the columns we need in our analysis:

```{r Select the columns we need in our analysis}
a10 <- a10 %>% select(Month, Concession, Type, Cost)
a10

```

Summarise allows us to combine data across keys:

```{r example of summarise}
a10 <- a10 %>% summarise(TotalCost = sum(Cost))
a10
```

Create new variables using the `mutate` function:

```{r}
a10 <- a10 %>% mutate(TotalCost = TotalCost / 1e6)
a10
```

## Read a CSV file and convert to a table:

```{r Read a CSV file and convert to a table}
prison <- readr::read_csv('https://OTexts.com/fpp3/extrafiles/prison_population.csv')

prison <- prison %>% 
  mutate(Quarter = yearquarter(Date)) %>% 
  select(-Date) %>% 
  as_tsibble(key = c(State, Gender, Legal, Indigenous),
             index = Quarter)
prison

```

## 2.2 Time plots

For time series data, the obvious graph to start with is a time plot. That is, the observations are plotted against the time of observation, with consecutive observations joined by straight lines. Figure 2.1 shows the weekly economy passenger load on Ansett airlines between Australia’s two largest cities.

```{r Time series plot}
melsyd_economy <- ansett %>% 
  filter(Airports == "MEL-SYD", Class == "Economy") %>% 
  mutate(Passengers = Passengers / 1000)
autoplot(melsyd_economy, Passengers) +
  labs(title = "Ansett airline economy class",
       subtitle = "Melbourne-Sydney",
       y = "Passengers ('000)")
```

The time plot immediately reveals some interesting features.

• There was a period in 1989 when no passengers were carried — this was due to an industrial dispute.<br>
• There was a period of reduced load in 1992. This was due to a trial in which some economy class seats were replaced by business class seats.<br>
• A large increase in passenger load occurred in the second half of 1991.<br>
• There are some large dips in load around the start of each year. These are due to holiday effects.
• There is a long-term fluctuation in the level of the series which increases during 1987, decreases in 1989, and increases again through 1990 and 1991.<br>
• There are some periods of missing observations.<br>

Let's take a look at the a10 data saved earlier, plotted as a time series:

```{r a10 data saved as a time series}
autoplot(a10, TotalCost) +
  labs(y = "$ millionss",
       title = "Australian antidiabetic drug sales")

```

## 2.3 Time Series Patterns

<span style="color:#0000ff;">Trend</span><br>
A trend exists when there is a long-term increase or decrease in the data. It does not have to be linear. Sometimes we will refer to a trend as “changing direction,” when it might go from an increasing trend to a decreasing trend. There is a trend in the antidiabetic drug sales data shown in Figure 2.2.<br>
<span style="color:#0000ff;">Seasonal</span><br>
A seasonal pattern occurs when a time series is affected by seasonal factors such as the time of the year or the day of the week. Seasonality is always of a fixed and known period. The monthly sales of antidiabetic drugs (Figure 2.2) shows seasonality which is induced partly by the change in the cost of the drugs at the end of the calendar year.<br>
<span style="color:#0000ff;">Cyclic</span><br>
A cycle occurs when the data exhibit rises and falls that are not of a fixed frequency. These fluctuations are usually due to economic conditions, and are often related to the “business cycle.” The duration of these fluctuations is usually at least 2 years.<br>

## 2.4 Seasonal plots

A seasonal plot is similar to a time plot except that the data are plotted against the individual “seasons” in which the data were observed. An example is given in Figure 2.4 showing the antidiabetic drug sales.

```{r Seasonal plot: Antidiabetic drug sales}
a10 %>%
  gg_season(TotalCost, labels = "both") +
  labs(y = "$ millions",
       title = "Seasonal plot: Antidiabets drug sales") +
  expand_limits(x = ymd(c("1972-12-28", "1973-12-04")))
```

### Multiple seasonal periods

Where the data has more than one seasonal pattern, the period argument can be used to select which seasonal plot is required. The vic_elec data contains half-hourly electricity demand for the state of Victoria, Australia. We can plot the daily pattern, weekly pattern or yearly pattern by specifying the period argument.

```{r Plotting multiple seasonal periods}
vic_elec %>% gg_season(Demand, period = "day") +
  theme(legend.position = "none") +
  labs(y = "MW", title = "Electricity demand: Victoria")

```



```{r Seasonal plot showing weekly seasonal patterns for Victorian electricity demand.}

vic_elec %>% gg_season(Demand, period = "week") +
  theme(legend.position = "none") +
  labs(y = "MW", title = "Electricity demand: Victoria by day of the week")

```

```{r Seasonal plot showing yearly seasonal patterns for Victorian electricity demand.}

vic_elec %>% gg_season(Demand, period = "year") +
  labs(y="Megawatts", title = "Electricity demand: Victoria") 

```

